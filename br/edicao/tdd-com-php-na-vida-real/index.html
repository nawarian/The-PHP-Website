<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <link rel="stylesheet" href="/assets/build/css/main.css?id=05612b6493f3dc308ba1">
  <link
    rel="alternate"
    type="application/json"
    title="JSON Feed"
    href="https://thephp.website/br/feed.json"
  />

  <title>TDD com PHP na vida real | The PHP Website</title>

  <meta name="description" content="Neste post eu explico como eu fa√ßo Test-Driven Development com PHP. O foco √© no ciclo de feedback que o TDD prov√™, e quais ferramentas s√£o adequadas para alcan√ßar este ciclo enquanto programo em PHP.">

  <meta property="og:title" content="TDD com PHP na vida real">
  <meta property="og:description" content="Neste post eu explico como eu fa√ßo Test-Driven Development com PHP. O foco √© no ciclo de feedback que o TDD prov√™, e quais ferramentas s√£o adequadas para alcan√ßar este ciclo enquanto programo em PHP.">
  <meta property="og:url" content="https://thephp.website/br/edicao/tdd-com-php-na-vida-real">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@nawarian">
  <meta name="twitter:title" content="TDD com PHP na vida real">
  <meta name="twitter:description" content="Neste post eu explico como eu fa√ßo Test-Driven Development com PHP. O foco √© no ciclo de feedback que o TDD prov√™, e quais ferramentas s√£o adequadas para alcan√ßar este ciclo enquanto programo em PHP.">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-151169766-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-151169766-2');
  </script>
</head>
<body class="yue">
  <header>
          <time datetime="2019-11-03">
        2019-11-03
      </time>
        <nav class="align-right">
      <a href="/br">üáßüá∑</a> | <a href="/en">üá¨üáß</a>
    </nav>
  </header>
<h1>TDD com PHP na vida real</h1>

<p><a href="/en/issue/real-life-tdd-php">Read in English</a></p>
<p><strong>Antes de tudo</strong></p>
<p>TDD t√™m v√°rias t√©cnicas a serem utilizadas, este post apresenta algumas
delas. Se voc√™ est√° procurando se aprofundar mais no assunto, tem um livro
bom pra ti: <strong><em>&quot;Test Driven Development: By Example&quot;</em>, por Kent Beck</strong>.</p>
<p>Todo c√≥digo escrito aqui est√° dispon√≠vel no <a href="https://github.com/nawarian/The-PHP-Website/tree/master/code/1-real-life-tdd-with-php/archive-org-client">reposit√≥rio do github thephp.website</a>.</p>
<p><strong>Modo enrola√ß√£o: desligado</strong> (bora codar!)</p>
<p>Test Driven Development n√£o √© sobre escrever testes unit√°rios, mas sim
sobre <strong>escrever teste primeiro</strong>.</p>
<p>Testes n√£o s√£o a coisa mais importante, <strong>a gente escreve eles pra ter
um ciclo constante de feedback</strong> durante o desenvolvidomento.</p>
<p>Com isso em mente, o nosso ciclo de desenvolvimento √© o seguinte:</p>
<ol>
<li><a href="#1-escreva-um-teste-superficial">Escreva um teste superficial, rode e veja-o falhar</a></li>
<li><a href="#2-faca-este-teste-passar-da-forma-mais-burra-possivel">Fa√ßa este teste passar da forma mais burra poss√≠vel</a></li>
<li><a href="#3-refatore-ate-que-nao-pareca-tao-burra">Refatore a implementa√ß√£o at√© que n√£o pare√ßa mais t√£o burra assim</a></li>
</ol>
<h2>Antes do &quot;como&quot;, vem o &quot;porqu√™&quot;</h2>
<p>Existem algumas √≥timas raz√µes pra escrever testes primeiro. Vamos alinhar
em algumas pra que tu possa ter uma ideia de por qu√™ manter essa pr√°tica.</p>
<p>Escrever testes primeiro:</p>
<ul>
<li>te for√ßa a saber o que voc√™ quer alcan√ßar antes de come√ßar a escrever c√≥digo</li>
<li>te mant√©m focado(a) em seu objetivo</li>
<li>te prov√™ uma estrutura com ciclo de feedback constante: alterar, salvar, verificar</li>
</ul>
<h2>Construindo um adapter para buscar metadados no Archive.org com TDD</h2>
<p>Como um exemplo razo√°vel, vamos construir um client que busca metadados sobre
itens dispon√≠vels no site Archive.org.</p>
<p><strong>O que sabemos:</strong></p>
<ul>
<li>Archive.org nos permite fazer o upload de arquivos e os chama de &quot;Item&quot;</li>
<li><a href="https://archive.org/details/nawarian-test">Aqui h√° um exemplo de item identificado por &quot;nawarian-test&quot;</a></li>
<li>Um item cont√©m multiplos arquivos, representando o arquivo em v√°rias
formas e seus metadados</li>
<li>Todo item cont√©m metadados como data de cria√ß√£o, nome, arquivos...</li>
<li>Archive.org prov√™ uma API para buscar metadados usando o seguinte URL:
<code>https://archive.org/metadata/&lt;nome-do-item&gt;</code></li>
</ul>
<p><strong>O que a gente quer:</strong></p>
<p>Uma classe para buscar os metadados de um item no Archive.org e que
nos retorne uma entidade chamada <code>Nawarian\ArchiveOrg\Item\Metadata</code>.</p>
<p>Vamos construir um setup b√°sico pra escrever nosso teste que garanta
o que a gente quer!</p>
<h2>Configura√ß√£o do ambiente de teste</h2>
<p>Rapidex: vamos criar uma pasta para o nosso projeto, instalar os
pacotes necess√°rios e botar os testes pra rodar. O meu setup normalmente
vem com PHPUnit e Mockery:</p>
<pre><code class="language-shell">$ mkdir archive-org-client/ &amp;&amp; cd archive-org-client
$ composer require phpunit/phpunit mockery/mockery
$ ./vendor/bin/phpunit --generate-configuration</code></pre>
<p>Ao gerar as configura√ß√µes do phpunit, a ferramenta vai lhe perguntar sobre
diret√≥rio de testes e outras coisas. Vamos pegar as op√ß√µes padr√£o pra tudo
aqui (s√≥ aperta &quot;enter&quot;).</p>
<p>A configura√ß√£o padr√£o diz que os nossos testes ficam dentro da pasta <code>tests</code>,
e o nosso c√≥digo fica dentro da pasta <code>src</code>. Vamos cri√°-las:</p>
<pre><code class="language-shell">$ mkdir tests src</code></pre>
<p>A gente tamb√©m precisa configurar o <strong>autoloader</strong> do composer. Vamos
atualizar o arquivo <code>composer.json</code>, vai ficar assim:</p>
<p>Arquivo: <strong>composer.json</strong></p>
<pre><code class="language-json">{
    "require": {
        "phpunit/phpunit": "^8.4",
        "mockery/mockery": "^1.2"
    },
    "autoload": {
        "psr-4": {
            "Nawarian\\ArchiveOrg\\": "src/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Nawarian\\ArchiveOrg\\Test\\": "tests/"
        }
    }
}</code></pre>
<p>Atualizado o <code>composer.json</code>, vamos gerar o autoloader novamente:</p>
<pre><code class="language-shell">$ composer dump-autoload</code></pre>
<p>Agora a gente pode criar a nossa classe de testes e come√ßar a brincadeira!</p>
<p>Arquivo: <strong>tests/ClientTest.php</strong></p>
<pre><code class="language-php">&lt;?php

namespace Nawarian\ArchiveOrg\Test;

use PHPUnit\Framework\TestCase;

class ClientTest extends TestCase
{
    public function testMyTest(): void
    {
        $this-&gt;assertTrue(true);
    }
}</code></pre>
<p>E podemos rodar o phpunit normalmente:</p>
<pre><code class="language-shell">$ ./vendor/bin/phpunit -c phpunit.xml</code></pre>
<p>Muintcho beeim! Com o teste configurado e rodando, vamos come√ßar
com o TDD.</p>
<h3 id="1-escreva-um-teste-superficial">
    1. Escreva um teste superficial, rode e veja-o falhar
</h3>
<p>Novamente, nosso objetivo √©: uma classe para buscar os metadados de
um item no Archive.org e que nos retorne uma entidade chamada
<code>Nawarian\ArchiveOrg\Item\Metadata</code>.</p>
<p>Nosso teste vai ent√£o se parecer com o seguinte:</p>
<p>Arquivo: <strong>tests/ClientTest.php</strong></p>
<pre><code class="language-php">&lt;?php

namespace Nawarian\ArchiveOrg\Test;

use PHPUnit\Framework\TestCase;

class ClientTest extends TestCase
{
    public function testClientFetchesMetadata(): void
    {
        $client = new \Nawarian\ArchiveOrg\Client();

        $metadata = $client-&gt;fetchMetadata('nawarian-test');

        $this-&gt;assertSame('nawarian-test', $metadata-&gt;identifier());
        $this-&gt;assertSame('2019-02-19 20:00:38', $metadata-&gt;publicDate());
        $this-&gt;assertSame('opensource', $metadata-&gt;collection());
    }
}</code></pre>
<p>Pronto! A gente precisa de um <code>Client</code> que cont√©m um m√©todo <code>fetchMetadata()</code>,
que receba uma string <code>identifier</code> (nawarian-test neste caso).</p>
<p>A gente tamb√©m quer que o retorno seja um objeto com os m√©todos <code>identifier()</code>,
<code>publicDate()</code> e <code>collection()</code>, retornando cada um os valores dispon√≠veis na API.</p>
<p><strong>Salve o arquivo, rode o phpunit e veja o teste falhar.</strong></p>
<h3 id="2-faca-este-teste-passar-da-forma-mais-burra-possivel">
    2. Fa√ßa este teste passar da forma mais burra poss√≠vel
</h3>
<p>O primeiro erro que vemos diz que a classe Client n√£o foi encontrada:
<code>Class 'Nawarian\ArchiveOrg\Client' not found</code>.</p>
<p>Corrigir este √© bem simples, criamos uma classe com o mesmo FQN. Dentro da
pasta <code>src/</code>, claro.</p>
<p>Arquivo: <strong>src/Client.php</strong></p>
<pre><code class="language-php">&lt;?php

namespace Nawarian\ArchiveOrg;

class Client
{
}</code></pre>
<p>Salve, rode o phpunit. O pr√≥ximo erro diz
<code>Call to undefined method Nawarian\ArchiveOrg\Client::fetchMetadata()</code>.
Ainda mais f√°cil, basta escrever o m√©todo na classe <code>Client</code>:</p>
<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    return new \stdClass();
}</code></pre>
<p>Salve, rode o phpunit. O pr√≥ximo erro diz
<code>Call to undefined method stdClass::identifier()</code>.
Vamos ent√£o usar uma classe an√¥nima pra acabar com esses erros
e seguir em frente!</p>
<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    return new class {
        public function identifier(): string
        {
            return '';
        }

        public function publicDate(): string
        {
            return '';
        }

        public function collection(): string
        {
            return '';
        }
    };
}</code></pre>
<p>O que falta agora √© fazer o teste passar <strong>da forma mais burra poss√≠vel</strong>.
Eu consigo somente pensar em retornar direto os valores que passa no teste:</p>
<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    return new class {
        public function identifier(): string
        {
            return 'nawarian-test';
        }

        public function publicDate(): string
        {
            return '2019-02-19 20:00:38';
        }

        public function collection(): string
        {
            return 'opensource';
        }
    };
}</code></pre>
<p>Massa! Os testes passaram! √â hora de fazer uma implementa√ß√£o de verdade,
pra poder buscar os metadados da API em si. <strong>A partir deste momento a
gente inicia o ciclo constante de feedback durante o desenvolvimento.</strong></p>
<h3 id="3-refatore-ate-que-nao-pareca-tao-burra">
    3. Refatore a implementa√ß√£o at√© que n√£o pare√ßa mais t√£o burra assim
</h3>
<p>O termo <strong>at√© que</strong> √© extremamente importante aqui. N√≥s estamos no
√∫ltimo passo, mas tamb√©m o passo que mais se repete.</p>
<p>Isto significa que n√≥s vamos continuar retornando a este passo at√©
que estejamos contentes com a implementa√ß√£o. </p>
<p><strong>3.1 Introduzindo a classe <code>Item\Metadata</code></strong></p>
<p>A primeira coisa que eu sinto ser necess√°ria √© escrever a entidade <code>Metadata</code>,
desta forma a gente pode remover a classe an√¥nima. Vamos l√°:</p>
<p>Arquivo: <strong>src/Item/Metadata.php</strong> (m√©todos copiados da classe an√¥nima em Client)</p>
<pre><code class="language-php">&lt;?php

namespace Nawarian\ArchiveOrg\Item;

class Metadata
{
    public function identifier(): string
    {
        return 'nawarian-test';
    }

    public function publicDate(): string
    {
        return '2019-02-19 20:00:38';
    }

    public function collection(): string
    {
        return 'opensource';
    }
}</code></pre>
<p>Vamos atualizar a implementa√ß√£o em <code>Client::fetchMetadata()</code>. Observe
como o retorno do m√©todo mudou para <code>Metadata</code>.</p>
<p>Arquivo: <strong>src/Client.php</strong></p>
<pre><code class="language-php">// ...

use Nawarian\ArchiveOrg\Item\Metadata;

// class Client...

public function fetchMetadata(string $identifier): Metadata
{
    return new Metadata();
}</code></pre>
<p>Salve, rode o phpunit. Os testes ainda est√£o passando. Estamos indo bem!</p>
<p><strong>3.2 Receber os dados no construtor da entidade <code>Metadata</code></strong></p>
<p>Em vez de escrever os resultados direto no arquivo da classe <code>Metadata</code>,
vamos delegar a responsabilidade de montar os dados para a classe <code>Client</code>
e receb√™-los no construtor de <code>Metadata</code>.</p>
<p>Arquivo: <strong>src/Item/Metadata.php</strong></p>
<pre><code class="language-php">class Metadata
{
    private $identifier;

    private $publicDate;

    private $collection;

    public function __construct(string $identifier, string $publicDate, string $collection)
    {
        $this-&gt;identifier = $identifier;
        $this-&gt;publicDate = $publicDate;
        $this-&gt;collection = $collection;
    }

    public function identifier(): string
    {
        return $this-&gt;identifier;
    }

    public function publicDate(): string
    {
        return $this-&gt;publicDate;
    }

    public function collection(): string
    {
        return $this-&gt;collection;
    }
}</code></pre>
<p>E agora vamos delegar a responsabilidade de montar os dados para a
classe <code>Client</code>.</p>
<p>Arquivo: <strong>src/Client.php</strong></p>
<pre><code class="language-php">public function fetchMetadata(string $identifier): Metadata
{
    return new Metadata('nawarian-test', '2019-02-19 20:00:38', 'opensource');
}</code></pre>
<p>Salve, rode o phpunit. Ainda est√° verde. Continuemos.</p>
<p><strong>3.3 Chamando a API para buscar dados de verdade</strong></p>
<p><code>Client</code> ainda est√° produzindo dados falsos, o que n√£o √© bem √∫til.
Vamos usar a API do archive.org pra buscar os dados que precisamos.</p>
<p>Lembrando que o endpoint √© <code>https://archive.org/metadata/&lt;identificador&gt;</code>.
Ent√£o invocar o m√©todo <code>Client::fetchMetadata()</code> passando <code>nawarian-test</code> como
identificador (os teste que escrevemos j√° faz isso), n√≥s dever√≠amos chamar
<code>https://archive.org/metadata/nawarian-test</code>.</p>
<p>Eu vou implementar isto rapidinho usando <code>file_get_contents()</code>.</p>
<p>Arquivo: <strong>src/Client.php</strong></p>
<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    $jsonData = file_get_contents("https://archive.org/metadata/{$identifier}");
    $decoded = json_decode($jsonData, true);
    $metadata = $decoded['metadata'];

    return new Metadata(
        $metadata['identifier'],
        $metadata['publicdate'],
        $metadata['collection']
    );
}</code></pre>
<p>Salve, rode o phpunit. Testes est√£o passando e... n√≥s atingimos nosso objetivo!</p>
<h2>Continue refatorando ou pare por aqui</h2>
<p>A ideia do ciclo de feedback descrito no passo 3.3 √© implementar nosso c√≥digo
com base num objetivo bem definido.</p>
<p>Voc√™ encontr√° v√°rios momentos de &quot;aaah&quot;, e vai querer implementar da melhor
forma poss√≠vel desde o inc√≠cio. <strong>N√£o caia nessa armadilha!</strong></p>
<p>Quanto maior o tempo voc√™ passa sem feedback (sem ver os resultados dos testes),
maiores s√£o as chances de quebrar o seu c√≥digo sem entender onde ocorreu o problema.</p>
<p>Sempre que voc√™ encontrar algo que sinta ser muito importante, anote e continue
indo em frente! Bote esta anota√ß√£o como a pr√≥xima coisa a resolver no seu ciclo,
mas n√£o interrompa a itera√ß√£o atual.</p>
<p>Eu posso exemplificar algumas coisas que eu gostaria de ter feito nessa implementa√ß√£o:</p>
<ul>
<li>usar um client http compat√≠vel com a PSR-18 e remover a chamada
√† fun√ß√£o <code>file_get_contents()</code></li>
<li>quebrar este teste em unit√°rio e de integra√ß√£o</li>
<li>um mecanismo de hydration melhor para a classe <code>Metadata</code> </li>
</ul>
<p>Tamb√©m importante notar que n√≥s n√£o testamos nenhum caso de exce√ß√£o. Estes testes
devem ser criados tamb√©m! Como deveria a nossa classe se comportar quando
<code>identificador</code> n√£o existe no archive.org?</p>
<p>Quanto mais voc√™ escreve c√≥digo, mais voc√™ ir√° querer escrever c√≥digo. Seu
trabalho aqui √© entender quando parar e iniciar o pr√≥ximo t√≥pico.</p>
<p><strong>Nunca se esque√ßa de manter o ciclo de feedback em andamento: refatore, salve,
rode o phpunit.</strong> </p>
<p>√â isso. N√£o tem mais motivo pra esperar pra implementar TDD.</p>
<p>Bora codar, leia o livro do Kent Beck e sinta-se convidado(a) a me dar um
toque pra discutir ou perguntar coisas.</p>
<div class="align-right">
  --
  <a href="https://twitter.com/nawarian">
    @nawarian
  </a>
</div>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "headline": "TDD com PHP na vida real",
  "description": "Neste post eu explico como eu fa&ccedil;o Test-Driven Development com PHP. O foco &eacute; no ciclo de feedback que o TDD prov&ecirc;, e quais ferramentas s&atilde;o adequadas para alcan&ccedil;ar este ciclo enquanto programo em PHP.",
  "image": [
    "https://thephp.website/assets/images/1-test.jpg"
   ],
  "datePublished": "2019-11-03T00:00:00+08:00",
  "dateModified": "2019-11-03T00:00:00+08:00",
  "author": {
    "@type": "Person",
    "name": "Nawarian N&iacute;ckolas Da Silva"
  },
   "publisher": {
    "@type": "Organization",
    "name": "ThePHP Website",
    "logo": {
      "@type": "ImageObject",
      "url": "https://thephp.website/favicon.ico"
    }
  }
}
</script></body>
<script src="/assets/build/js/main.js?id=859740b518dcddb1fe42"></script>
</html>
