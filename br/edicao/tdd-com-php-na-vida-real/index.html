<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <link rel="stylesheet" href="/assets/build/css/main.css?id=2e42c8808e21522a0c4d">
      <link rel="canonical" href="https://thephp.website/br/edicao/tdd-com-php-na-vida-real/" />
      <link
    rel="alternate"
    type="application/json"
    title="[BR] thePHP Website"
    href="https://thephp.website/br/feed.json"
  />
  <link
    rel="alternate"
    type="application/rss+xml"
    title="[BR] thePHP Website"
    href="https://thephp.website/br/feed.xml"
  />
  
  <title>Desenvolvimento Guiado a Testes no PHP com exemplos | thePHP Website</title>

  <meta name="description" content="Esta é a maneira como faço Test-Driven Development no PHP. O foco é no ciclo de feedback que o TDD traz, e quais ferramentas são adequadas para alcançar este ciclo enquanto programo em PHP.">

  <meta property="og:title" content="Desenvolvimento Guiado a Testes no PHP com exemplos">
  <meta property="og:description" content="Esta é a maneira como faço Test-Driven Development no PHP. O foco é no ciclo de feedback que o TDD traz, e quais ferramentas são adequadas para alcançar este ciclo enquanto programo em PHP.">
  <meta property="og:url" content="https://thephp.website/br/edicao/tdd-com-php-na-vida-real">
  <meta property="og:image" content="https://thephp.website/assets/images/posts/1-test-640.webp">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@nawarian">
  <meta name="twitter:title" content="Desenvolvimento Guiado a Testes no PHP com exemplos">
  <meta name="twitter:description" content="Esta é a maneira como faço Test-Driven Development no PHP. O foco é no ciclo de feedback que o TDD traz, e quais ferramentas são adequadas para alcançar este ciclo enquanto programo em PHP.">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-151169766-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-151169766-3');
  </script>
  <script data-ad-client="ca-pub-3681134868307419" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Hotjar Tracking Code for thephp.website -->
  <script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1770868,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
  </script>
  <script>
    function toggleMenu() {
      document.querySelector('.menu__container').classList.toggle('menu__container--active');
    }
  </script>
</head>
<body class="yue non-article">
  <header class="menu">
    <a class="menu__logo" href="/br/">
      <img src="/assets/images/elephpant-idle.png" alt="" />
    </a>
    <div class="menu__title">
      <a href="/br/">thePHP Website</a>
    </div>
    <section class="menu__cta">
      <button role="button" aria-label="Open Menu" class="menu__cta__icon" onclick="typeof toggleMenu == 'function' &amp;&amp; toggleMenu()">
        <img alt="Open Menu" src="https://podentender.com.br/assets/images/icons/menu.svg">
      </button>
    </section>

    <div class="menu__container">
      <em class="menu__section-heading">
        Pages.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="/br/">Home</a>
        </li>
        <li class="menu__list-item">
          <a href="/br/busca">
            busca.php
          </a>
        </li>
        <li class="menu__list-item">
          <a
            href="https://github.com/nawarian/The-PHP-Website/issues/new?title=[Suggested+Topic]%20&body=Please+describe+your+suggestion+/+Por+favor+descreva+sua+sugestão"
            rel="nofollow"
          >
            Peça um Post!
          </a>
        </li>
        <li class="menu__list-item">
          <a href="/br/sobre/">
            sobre.php
          </a>
        </li>
      </ul>

      <hr>
      <em class="menu__section-heading">
        Languages.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="/en/">English</a>
        </li>
        <li class="menu__list-item">
          <a href="/br/">Português</a>
        </li>
      </ul>

      <hr>
      <em class="menu__section-heading">
        Notifications.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="https://thephp.website/br/feed.json">
            [BR] JSON Feed
          </a>
        </li>
        <li class="menu__list-item">
          <a href="https://thephp.website/br/feed.xml">
            [BR] Atom Feed (RSS)
          </a>
        </li>
                <li class="menu__list-item">
          <a href="https://thephp.website/br/feed-vagas.xml">
            Feed de Vagas (RSS)
          </a>
        </li>
              </ul>
    </div>
  </header>
  <article class="container">
      <div class="article">
    <time datetime="2019-11-03">
      2019-11-03
    </time>

    <h1>Desenvolvimento Guiado a Testes no PHP com exemplos</h1>
    <p><a href="/en/issue/real-life-tdd-php">Read in English</a></p>

<p><strong>Antes de tudo</strong></p>

<p>TDD têm várias técnicas a serem utilizadas, este post apresenta algumas
delas. Se você está procurando se aprofundar mais no assunto, tem um livro
bom pra ti: <strong><em>"Test Driven Development: By Example"</em>, por Kent Beck</strong>.</p>

<p>Todo código escrito aqui está disponível no <a href="https://github.com/nawarian/The-PHP-Website/tree/master/code/1-real-life-tdd-with-php/archive-org-client">repositório do github thephp.website</a>.</p>

<p><strong>Modo enrolação: desligado</strong> (bora codar!)</p>

<p>Test Driven Development não é sobre escrever testes unitários, mas sim
sobre <strong>escrever teste primeiro</strong>.</p>

<p>Testes não são a coisa mais importante, <strong>a gente escreve eles pra ter
um ciclo constante de feedback</strong> durante o desenvolvidomento.</p>

<p>Com isso em mente, o nosso ciclo de desenvolvimento é o seguinte:
1. <a href="#1-escreva-um-teste-superficial">Escreva um teste superficial, rode e veja-o falhar</a>
1. <a href="#2-faca-este-teste-passar-da-forma-mais-burra-possivel">Faça este teste passar da forma mais burra possível</a>
1. <a href="#3-refatore-ate-que-nao-pareca-tao-burra">Refatore a implementação até que não pareça mais tão burra assim</a></p>

<h2>Antes do "como", vem o "porquê"</h2>

<p>Existem algumas ótimas razões pra escrever testes primeiro. Vamos alinhar
em algumas pra que tu possa ter uma ideia de por quê manter essa prática.</p>

<p>Escrever testes primeiro:
* te força a saber o que você quer alcançar antes de começar a escrever código
* te mantém focado(a) em seu objetivo
* te provê uma estrutura com ciclo de feedback constante: alterar, salvar, verificar</p>

<h2>Construindo um adapter para buscar metadados no Archive.org com TDD</h2>

<p>Como um exemplo razoável, vamos construir um client que busca metadados sobre
itens disponívels no site Archive.org.</p>

<p><strong>O que sabemos:</strong></p>

<ul>
<li>Archive.org nos permite fazer o upload de arquivos e os chama de "Item"</li>
<li><a href="https://archive.org/details/nawarian-test">Aqui há um exemplo de item identificado por "nawarian-test"</a></li>
<li>Um item contém multiplos arquivos, representando o arquivo em várias
formas e seus metadados</li>
<li>Todo item contém metadados como data de criação, nome, arquivos...</li>
<li>Archive.org provê uma API para buscar metadados usando o seguinte URL:
<code>https://archive.org/metadata/&lt;nome-do-item&gt;</code></li>
</ul>

<p><strong>O que a gente quer:</strong></p>

<p>Uma classe para buscar os metadados de um item no Archive.org e que
nos retorne uma entidade chamada <code>Nawarian\ArchiveOrg\Item\Metadata</code>.</p>

<p>Vamos construir um setup básico pra escrever nosso teste que garanta
o que a gente quer!</p>

<h2>Configuração do ambiente de teste</h2>

<p>Rapidex: vamos criar uma pasta para o nosso projeto, instalar os
pacotes necessários e botar os testes pra rodar. O meu setup normalmente
vem com PHPUnit e Mockery:</p>

<pre><code class="language-shell">$ mkdir archive-org-client/ &amp;&amp; cd archive-org-client
$ composer require phpunit/phpunit mockery/mockery
$ ./vendor/bin/phpunit --generate-configuration
</code></pre>

<p>Ao gerar as configurações do phpunit, a ferramenta vai lhe perguntar sobre
diretório de testes e outras coisas. Vamos pegar as opções padrão pra tudo
aqui (só aperta "enter").</p>

<p>A configuração padrão diz que os nossos testes ficam dentro da pasta <code>tests</code>,
e o nosso código fica dentro da pasta <code>src</code>. Vamos criá-las:</p>

<pre><code class="language-shell">$ mkdir tests src
</code></pre>

<p>A gente também precisa configurar o <strong>autoloader</strong> do composer. Vamos
atualizar o arquivo <code>composer.json</code>, vai ficar assim:</p>

<p>Arquivo: <strong>composer.json</strong></p>

<pre><code class="language-json">{
    "require": {
        "phpunit/phpunit": "^8.4",
        "mockery/mockery": "^1.2"
    },
    "autoload": {
        "psr-4": {
            "Nawarian\\ArchiveOrg\\": "src/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Nawarian\\ArchiveOrg\\Test\\": "tests/"
        }
    }
}
</code></pre>

<p>Atualizado o <code>composer.json</code>, vamos gerar o autoloader novamente:</p>

<pre><code class="language-shell">$ composer dump-autoload
</code></pre>

<p>Agora a gente pode criar a nossa classe de testes e começar a brincadeira!</p>

<p>Arquivo: <strong>tests/ClientTest.php</strong></p>

<pre><code class="language-php">&lt;?php

namespace Nawarian\ArchiveOrg\Test;

use PHPUnit\Framework\TestCase;

class ClientTest extends TestCase
{
    public function testMyTest(): void
    {
        $this-&gt;assertTrue(true);
    }
}
</code></pre>

<p>E podemos rodar o phpunit normalmente:</p>

<pre><code class="language-shell">$ ./vendor/bin/phpunit -c phpunit.xml
</code></pre>

<p>Muintcho beeim! Com o teste configurado e rodando, vamos começar
com o TDD.</p>

<h3 id="1-escreva-um-teste-superficial">
    1. Escreva um teste superficial, rode e veja-o falhar
</h3>

<p>Novamente, nosso objetivo é: uma classe para buscar os metadados de
um item no Archive.org e que nos retorne uma entidade chamada
<code>Nawarian\ArchiveOrg\Item\Metadata</code>.</p>

<p>Nosso teste vai então se parecer com o seguinte:</p>

<p>Arquivo: <strong>tests/ClientTest.php</strong></p>

<pre><code class="language-php">&lt;?php

namespace Nawarian\ArchiveOrg\Test;

use PHPUnit\Framework\TestCase;

class ClientTest extends TestCase
{
    public function testClientFetchesMetadata(): void
    {
        $client = new \Nawarian\ArchiveOrg\Client();

        $metadata = $client-&gt;fetchMetadata('nawarian-test');

        $this-&gt;assertSame('nawarian-test', $metadata-&gt;identifier());
        $this-&gt;assertSame('2019-02-19 20:00:38', $metadata-&gt;publicDate());
        $this-&gt;assertSame('opensource', $metadata-&gt;collection());
    }
}
</code></pre>

<p>Pronto! A gente precisa de um <code>Client</code> que contém um método <code>fetchMetadata()</code>,
que receba uma string <code>identifier</code> (nawarian-test neste caso).</p>

<p>A gente também quer que o retorno seja um objeto com os métodos <code>identifier()</code>,
<code>publicDate()</code> e <code>collection()</code>, retornando cada um os valores disponíveis na API.</p>

<p><strong>Salve o arquivo, rode o phpunit e veja o teste falhar.</strong></p>

<h3 id="2-faca-este-teste-passar-da-forma-mais-burra-possivel">
    2. Faça este teste passar da forma mais burra possível
</h3>

<p>O primeiro erro que vemos diz que a classe Client não foi encontrada:
<code>Class 'Nawarian\ArchiveOrg\Client' not found</code>.</p>

<p>Corrigir este é bem simples, criamos uma classe com o mesmo FQN. Dentro da
pasta <code>src/</code>, claro.</p>

<p>Arquivo: <strong>src/Client.php</strong></p>

<pre><code class="language-php">&lt;?php

namespace Nawarian\ArchiveOrg;

class Client
{
}
</code></pre>

<p>Salve, rode o phpunit. O próximo erro diz
<code>Call to undefined method Nawarian\ArchiveOrg\Client::fetchMetadata()</code>.
Ainda mais fácil, basta escrever o método na classe <code>Client</code>:</p>

<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    return new \stdClass();
}
</code></pre>

<p>Salve, rode o phpunit. O próximo erro diz
<code>Call to undefined method stdClass::identifier()</code>.
Vamos então usar uma classe anônima pra acabar com esses erros
e seguir em frente!</p>

<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    return new class {
        public function identifier(): string
        {
            return '';
        }

        public function publicDate(): string
        {
            return '';
        }

        public function collection(): string
        {
            return '';
        }
    };
}
</code></pre>

<p>O que falta agora é fazer o teste passar <strong>da forma mais burra possível</strong>.
Eu consigo somente pensar em retornar direto os valores que passa no teste:</p>

<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    return new class {
        public function identifier(): string
        {
            return 'nawarian-test';
        }

        public function publicDate(): string
        {
            return '2019-02-19 20:00:38';
        }

        public function collection(): string
        {
            return 'opensource';
        }
    };
}
</code></pre>

<p>Massa! Os testes passaram! É hora de fazer uma implementação de verdade,
pra poder buscar os metadados da API em si. <strong>A partir deste momento a
gente inicia o ciclo constante de feedback durante o desenvolvimento.</strong></p>

<h3 id="3-refatore-ate-que-nao-pareca-tao-burra">
    3. Refatore a implementação até que não pareça mais tão burra assim
</h3>

<p>O termo <strong>até que</strong> é extremamente importante aqui. Nós estamos no
último passo, mas também o passo que mais se repete.</p>

<p>Isto significa que nós vamos continuar retornando a este passo até
que estejamos contentes com a implementação.</p>

<p><strong>3.1 Introduzindo a classe <code>Item\Metadata</code></strong></p>

<p>A primeira coisa que eu sinto ser necessária é escrever a entidade <code>Metadata</code>,
desta forma a gente pode remover a classe anônima. Vamos lá:</p>

<p>Arquivo: <strong>src/Item/Metadata.php</strong> (métodos copiados da classe anônima em Client)</p>

<pre><code class="language-php">&lt;?php

namespace Nawarian\ArchiveOrg\Item;

class Metadata
{
    public function identifier(): string
    {
        return 'nawarian-test';
    }

    public function publicDate(): string
    {
        return '2019-02-19 20:00:38';
    }

    public function collection(): string
    {
        return 'opensource';
    }
}
</code></pre>

<p>Vamos atualizar a implementação em <code>Client::fetchMetadata()</code>. Observe
como o retorno do método mudou para <code>Metadata</code>.</p>

<p>Arquivo: <strong>src/Client.php</strong></p>

<pre><code class="language-php">// ...

use Nawarian\ArchiveOrg\Item\Metadata;

// class Client...

public function fetchMetadata(string $identifier): Metadata
{
    return new Metadata();
}
</code></pre>

<p>Salve, rode o phpunit. Os testes ainda estão passando. Estamos indo bem!</p>

<p><strong>3.2 Receber os dados no construtor da entidade <code>Metadata</code></strong></p>

<p>Em vez de escrever os resultados direto no arquivo da classe <code>Metadata</code>,
vamos delegar a responsabilidade de montar os dados para a classe <code>Client</code>
e recebê-los no construtor de <code>Metadata</code>.</p>

<p>Arquivo: <strong>src/Item/Metadata.php</strong></p>

<pre><code class="language-php">class Metadata
{
    private $identifier;

    private $publicDate;

    private $collection;

    public function __construct(string $identifier, string $publicDate, string $collection)
    {
        $this-&gt;identifier = $identifier;
        $this-&gt;publicDate = $publicDate;
        $this-&gt;collection = $collection;
    }

    public function identifier(): string
    {
        return $this-&gt;identifier;
    }

    public function publicDate(): string
    {
        return $this-&gt;publicDate;
    }

    public function collection(): string
    {
        return $this-&gt;collection;
    }
}
</code></pre>

<p>E agora vamos delegar a responsabilidade de montar os dados para a
classe <code>Client</code>.</p>

<p>Arquivo: <strong>src/Client.php</strong></p>

<pre><code class="language-php">public function fetchMetadata(string $identifier): Metadata
{
    return new Metadata('nawarian-test', '2019-02-19 20:00:38', 'opensource');
}
</code></pre>

<p>Salve, rode o phpunit. Ainda está verde. Continuemos.</p>

<p><strong>3.3 Chamando a API para buscar dados de verdade</strong></p>

<p><code>Client</code> ainda está produzindo dados falsos, o que não é bem útil.
Vamos usar a API do archive.org pra buscar os dados que precisamos.</p>

<p>Lembrando que o endpoint é <code>https://archive.org/metadata/&lt;identificador&gt;</code>.
Então invocar o método <code>Client::fetchMetadata()</code> passando <code>nawarian-test</code> como
identificador (os teste que escrevemos já faz isso), nós deveríamos chamar
<code>https://archive.org/metadata/nawarian-test</code>.</p>

<p>Eu vou implementar isto rapidinho usando <code>file_get_contents()</code>.</p>

<p>Arquivo: <strong>src/Client.php</strong></p>

<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    $jsonData = file_get_contents("https://archive.org/metadata/{$identifier}");
    $decoded = json_decode($jsonData, true);
    $metadata = $decoded['metadata'];

    return new Metadata(
        $metadata['identifier'],
        $metadata['publicdate'],
        $metadata['collection']
    );
}
</code></pre>

<p>Salve, rode o phpunit. Testes estão passando e... nós atingimos nosso objetivo!</p>

<h2>Continue refatorando ou pare por aqui</h2>

<p>A ideia do ciclo de feedback descrito no passo 3.3 é implementar nosso código
com base num objetivo bem definido.</p>

<p>Você encontrá vários momentos de "aaah", e vai querer implementar da melhor
forma possível desde o incício. <strong>Não caia nessa armadilha!</strong></p>

<p>Quanto maior o tempo você passa sem feedback (sem ver os resultados dos testes),
maiores são as chances de quebrar o seu código sem entender onde ocorreu o problema.</p>

<p>Sempre que você encontrar algo que sinta ser muito importante, anote e continue
indo em frente! Bote esta anotação como a próxima coisa a resolver no seu ciclo,
mas não interrompa a iteração atual.</p>

<p>Eu posso exemplificar algumas coisas que eu gostaria de ter feito nessa implementação:</p>

<ul>
<li>usar um client http compatível com a PSR-18 e remover a chamada
à função <code>file_get_contents()</code></li>
<li>quebrar este teste em unitário e de integração</li>
<li>um mecanismo de hydration melhor para a classe <code>Metadata</code></li>
</ul>

<p>Também importante notar que nós não testamos nenhum caso de exceção. Estes testes
devem ser criados também! Como deveria a nossa classe se comportar quando
<code>identificador</code> não existe no archive.org?</p>

<p>Quanto mais você escreve código, mais você irá querer escrever código. Seu
trabalho aqui é entender quando parar e iniciar o próximo tópico.</p>

<p><strong>Nunca se esqueça de manter o ciclo de feedback em andamento: refatore, salve,
rode o phpunit.</strong></p>

<p>É isso. Não tem mais motivo pra esperar pra implementar TDD.</p>

<p>Bora codar, leia o livro do Kent Beck e sinta-se convidado(a) a me dar um
toque pra discutir ou perguntar coisas.</p>

<div class="align-right">
  --
  <a href="https://twitter.com/nawarian" rel="nofollow">
    @nawarian
  </a>
</div>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "headline": "Desenvolvimento Guiado a Testes no PHP com exemplos",
  "description": "Esta é a maneira como faço Test-Driven Development no PHP. O foco é no ciclo de feedback que o TDD traz, e quais ferramentas são adequadas para alcançar este ciclo enquanto programo em PHP.",
  "image": [
    "https://thephp.website/assets/images/1-test.jpg"
   ],
  "datePublished": "2019-11-03T00:00:00+08:00",
  "dateModified": "2020-02-17T00:00:00+08:00",
  "author": {
    "@type": "Person",
    "name": "Nawarian Níckolas Da Silva"
  },
   "publisher": {
    "@type": "Organization",
    "name": "ThePHP Website",
    "logo": {
      "@type": "ImageObject",
      "url": "https://thephp.website/favicon.ico"
    }
  }
}
</script>
  </div>
  </article>
  <aside class="container">
          <div class="recommended">
      <h3>Keep reading</h3>
      <ul class="card-list">
                  <li class="card">
            <a href="https://thephp.website/br/edicao/subindo-arquivos-github/">
                              <div
                        class="card__image"
                        style="background-image: url(/assets/images/posts/18-uploading-files-github-640.webp)"
                        alt="Uma mulher desenvolvedora de software atrás de um computador com adesivos do mascote do Github"
                ></div>
              
              <div class="card__content">
                <h4>Subindo arquivos no GitHub</h4>
                <p>Subir arquivos para o GitHub é um processo simples que envolve o uso de alguns comandos no terminal como git status, add, commit, remote entre outros que veremos aqui.</p>
                <time>2020-11-06</time>
              </div>
            </a>
          </li>
                  <li class="card">
            <a href="https://thephp.website/br/edicao/como-escrever-crawlers-em-php/">
                              <div
                        class="card__image"
                        style="background-image: url(/assets/images/posts/16-many-books-and-magazines-640.webp)"
                        alt="Muitos livros e revistas."
                ></div>
              
              <div class="card__content">
                <h4>Como escrever crawlers decentes com PHP</h4>
                <p>Depois deste artigo você vai perceber o quanto você sofreu com seus crawlers em PHP. EXISTE uma forma melhor. Deixa eu lhe mostrar 😉</p>
                <time>2020-07-20</time>
              </div>
            </a>
          </li>
                  <li class="card">
            <a href="https://thephp.website/br/edicao/jogos-em-php/">
                              <div
                        class="card__image"
                        style="background-image: url(/assets/images/posts/14-snake-640.webp)"
                        alt="Uma cobra colorida olhando para a câmera."
                ></div>
              
              <div class="card__content">
                <h4>O jogo da cobrinha feito em PHP (com Raylib)</h4>
                <p>Eu vou te mostrar como é o código e as ferramentas que usei! Espero que isso tome sua atenção suficientemente para vermos esta extensão ganhar tração.</p>
                <time>2020-04-20</time>
              </div>
            </a>
          </li>
              </ul>
    </div>
    </aside>
</body>
<script src="/assets/build/js/main.js?id=62c9a83d4ba6e7454179"></script>
</html>
