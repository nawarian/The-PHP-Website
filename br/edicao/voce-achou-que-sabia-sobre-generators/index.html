<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <link rel="stylesheet" href="/assets/build/css/main.css?id=78c24f1afac6e0c515c0">
  <link
    rel="alternate"
    type="application/json"
    title="JSON Feed"
    href="https://thephp.website/br/feed.json"
  />

  <title>Voc√™ achou que sabia sobre Generators no PHP | The PHP Website</title>

  <meta name="description" content="Neste post eu falo sobre Generators em PHP, como trabalhar com Coroutines e como o ecossistema da linguagem poderia evoluir com isso.">

  <meta property="og:title" content="Voc√™ achou que sabia sobre Generators no PHP">
  <meta property="og:description" content="Neste post eu falo sobre Generators em PHP, como trabalhar com Coroutines e como o ecossistema da linguagem poderia evoluir com isso.">
  <meta property="og:url" content="https://thephp.website/br/edicao/voce-achou-que-sabia-sobre-generators">
  <meta property="og:image" content="https://thephp.website/assets/images/3-generators.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@nawarian">
  <meta name="twitter:title" content="Voc√™ achou que sabia sobre Generators no PHP">
  <meta name="twitter:description" content="Neste post eu falo sobre Generators em PHP, como trabalhar com Coroutines e como o ecossistema da linguagem poderia evoluir com isso.">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-151169766-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-151169766-2');
  </script>
</head>
<body class="yue">
  <nav class="menu">
    <input type="checkbox" id="menu-toggle" class="menu__toggle" />
    <label for="menu-toggle" class="menu__toggle-button">
      <img class="menu__toggle-button--inactive" src="/assets/images/burger-menu-icon.png" alt="Open Menu">
      <img class="menu__toggle-button--active" src="/assets/images/x-icon.png" alt="Close Menu">
    </label>
    <div class="menu__header">
      <a href="/br/">
        thePHP Website
      </a>
    </div>

    <div class="menu__container">
      <em class="menu__section-heading">
        Pages.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="/br/">Home</a>
        </li>
        <li class="menu__list-item">
          <a
            href="https://github.com/nawarian/The-PHP-Website/issues/new?title=[Suggested+Topic]%20&body=Please+describe+your+suggestion+/+Por+favor+descreva+sua+sugest√£o"
            rel="nofollow"
          >
            Pe√ßa um Post!
          </a>
        </li>
      </ul>

      <hr>
      <em class="menu__section-heading">
        Languages.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="/en/">English</a>
        </li>
        <li class="menu__list-item">
          <a href="/br/">Portugu√™s</a>
        </li>
      </ul>

      <hr>
      <em class="menu__section-heading">
        Notifications.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="https://thephp.website/br/feed.json">
            [BR] JSON Feed
          </a>
        </li>
        <li class="menu__list-item">
          <a href="https://thephp.website/br/feed.xml">
            [BR] Atom Feed (RSS)
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <article class="article">
          <time datetime="2019-12-11">
        2019-12-11
      </time>
    
    <h1>Voc√™ achou que sabia sobre Generators no PHP</h1>

    <p><a href="/en/issue/you-thought-you-knew-php-generators/">Read in English</a></p>
<h2>TL;DR</h2>
<p>Generators s√£o muito mais do que apenas dar yield em
vari√°veis pra evitar a utiliza√ß√£o de arrays. Eles nos
proveem com o poder do async, coroutines e v√°rias magias üßô!</p>
<p>Se voc√™ busca uma explica√ß√£o mais exaustiva, d√° uma sacada
<a href="https://nikic.github.io/2012/12/22/Cooperative-multitasking-using-coroutines-in-PHP.html">nesse artigo de 2012 do nikic</a>.</p>
<h2>O que s√£o Generators e o que eles fazem?</h2>
<p>Comecemos pela <a href="https://www.php.net/manual/en/language.generators.overview.php">documenta√ß√£o oficial</a>.
Encontraremos v√°rias pistas a partir dela!</p>
<p>Generators s√£o uma feature do php desde a vers√£o 5.5 da linguagem,
como voc√™ pode ver na <a href="https://wiki.php.net/rfc/generators">RFC sobre generators</a>.</p>
<p>A principal ideia dos Generators √© prover uma forma <strong>simplificada
de escrever iterators</strong> sem ter de implementar a interface
Iterator. Generators tamb√©m nos permite <strong>interromper o fluxo
de execu√ß√£o do c√≥digo</strong>, o que √© bem massa!</p>
<p>A forma como ele funciona √© utilizando a palavra-chave
<code>yield</code> dentro de uma fun√ß√£o. Ao fazer isso, o <strong>tipo
de retorno</strong> da sua fun√ß√£o <strong>automaticamente se transformar√°
em <a href="https://www.php.net/manual/en/class.generator.php"><code>\Generator</code></a></strong>.</p>
<p><strong>Ent√£o se liga!</strong> O c√≥digo abaixo <em>quebra</em> porque for√ßa
um tipo de retorno, mas a utiliza√ß√£o de Generators retorna
algo diferente:</p>
<pre><code class="language-php">// String como tipo de retorno, quebrar√°
function myGeneratorFunction(): string
{
  yield 'Generators'; // Transforma o tipo de retorno em \Generator

  // Fatal Error: tipo de retorno √© \Generator, estamos retornando string
  return 'The PHP Website';
}</code></pre>
<p>Por nos permitir interromper a execu√ß√£o do c√≥digo, isto
naturalmente nos permite gerenciar melhor a mem√≥ria em
nossos programas php. Tem um script famoso que ilustra
este caso:</p>
<pre><code class="language-php">// range comum
foreach (range(1, 10000) as $n) {
  echo $n . PHP_EOL;
}

// range baseado em Generators
function xrange(int $from, int $to) {
  for ($i = $from; $i &lt;= $to; $i++) {
    yield $i;
  }
}

foreach (xrange(1, 10000) as $n) {
  echo $n . PHP_EOL;
}</code></pre>
<p>A diferen√ßa? Alerta de super simplifica√ß√£o: <code>range()</code>
alocou mem√≥ria para 10.000 integers, enquanto <code>xrange()</code>
alocou mem√≥ria para apenas um.</p>
<p>Voc√™ provavelmente j√° sabia isso desde 2012, claro. Mas
vamos resumir aqui rapidex e partir pra parte divertida
do texto!</p>
<h3>O que PHP Generators fazem?</h3>
<p>Generators nos permitem <strong>criar iterators facilmente</strong> sem
precisar implementar a interface Iterator e permitem
<strong>interrup√ß√£o de c√≥digo</strong> para melhor gerenciamento de
mem√≥ria ou qualquer tipo de maluquice que voc√™ queira
construir.</p>
<p>Abaixo eu mostro um exemplo simples de generator e comento
alguns termos. Se voc√™ em algum momento ler alguma palavra-chave
que n√£o fa√ßa muito sentido, volta aqui e l√™ esse exemplo.</p>
<pre><code class="language-php">// Generator function
function xrange(): \Generator {
  // Contexto/corpo/escopo do Generator
  while (true) {
    yield 1;
  }
}

$xrange = xrange();
$xrange-&gt;next(); // Puxa o pr√≥ximo yield</code></pre>
<h2>O que voc√™ possivelmente n√£o sabe sobre Generators...</h2>
<p>Uma feature maravilhosa dos Generators que normalmente
deixam passar batido √© a capacidade de <strong>enviar valores
de volta para a Generator function</strong>.</p>
<p>Basicamente quando voc√™ d√° um <code>yield</code> dentro da generator
function, o c√≥digo p√°ra de executar l√° e volta para o
contexto de quem invocou o generator. De l√° √© poss√≠vel
enviar valores de volta para dentro da generator function.</p>
<p>Isso cria uma s√©rie de oportunidades para criar ferramentas
incr√≠veis que negociam o flow de processamento para voc√™.
Incluindo <strong>coroutines</strong>, <strong>programa√ß√£o ass√≠ncrona</strong> e
<strong>otimiza√ß√£o de coleta de dados</strong>. Tu vai curtir essa ultima,
segue a linha!</p>
<h3>Como enviar valores de volta para a generator function?</h3>
<p>Na verdade √© bem simples. Um objeto do tipo Generator implementa
todos os m√©todos de Iterator e alguns a mais. Um deles √©
o m√©todo <a href="https://www.php.net/manual/en/generator.send.php"><code>Generator::send()</code></a>,
que √© utilizado para enviar valores para dentro da generator
function.</p>
<p>Funciona da seguinte maneira:</p>
<ol>
<li>Algu√©m invoca a generator function</li>
<li>A generator function d√° yield em algo, interrompendo a
execu√ß√£o e voltando para quem a invocou</li>
<li>O m√©todo <code>send()</code> do objeto generator √© invocado,
que passa um valor como resultado do <code>yield</code> dentro da
generator function</li>
<li>A generator function continua executando com o valor passado</li>
</ol>
<p>T√° confuso n√©? Olha esse c√≥digo:</p>
<pre><code class="language-php">function meuGenerator(): Generator
{
  // 2. joga o valor 10 para quem chama a fun√ß√£o
  $vinte = yield 10;

  // 4. Continua a execu√ß√£o com o novo valor
  var_dump($vinte);
}

$gen = meuGenerator();
// 1. Inicia a execu√ß√£o
$dez = $gen-&gt;current();

// 3. Joga de volta o valor para o generator function
$gen-&gt;send($dez * 2);

// Sa√≠da: int(20)</code></pre>
<p><strong>Isso √© meio que tudo o que tu precisaria saber sobre Generators.</strong>
Quer dizer, voc√™ tamb√©m pode lan√ßar exceptions de fora da generator function
usando o m√©todo <code>Generator::throw()</code>. Mas isso √© meio que tudo mesmo...</p>
<p><strong>Mas √© claro que tem mais coisa pra ver!</strong> Voc√™ n√£o esperava
vir aqui com conte√∫do que encontraria facilmente noutro canto,
n√©?</p>
<p>Lendo o post do nikic (o de 2012 que eu citei acima) voc√™ pode
extrair informa√ß√µes muito mais profundas sobre o que pode ser
feito com Generators no php. Vai l√°, leia quantas vezes
julgar necess√°rio at√© absorver a ideia.</p>
<p>Isso tudo √© teoria e √© bem massa. Mas tem algumas <strong>implementa√ß√µes
reais de Generators que podem mudar a sua vida</strong> ou pelo menos
te fazer considerar um paradigma diferente.</p>
<h2>Para que s√£o utilizados Generators?</h2>
<p>Eu gostaria de lhe apresentar <strong>duas aplica√ß√µes maneiras de
Generators com PHP</strong>. Uma √© open source e tu pode come√ßar a
utilizar desde j√°. A outra √© mais um conceito e tu precisaria
desenvolver algo pra si.</p>
<h3>Desenvolvimento ass√≠ncrono: como o framework Amp funciona</h3>
<p>Eu sei, voc√™ provavelmente j√° ouviu falar do framework Amp e
como ele pode te ajudar a desenvolver c√≥digo ass√≠ncrono no PHP.</p>
<p><strong>Mas eu t√¥ aqui pra te tirar da camada de usu√°rio.</strong> Eu quero
que tu pense sobre como esse treco foi implementado e tenha
ao menos uma vis√£o superficial em como ele funciona e o qu√£o
dependente de Generators este framework √©.</p>
<p>Considere o seguinte exemplo incompleto:</p>
<pre><code class="language-php">Amp\Loop::run(function () {
  $socket = yield connect(
    'localhost:443'
  );

  // object(EncryptableSocket)
  var_dump($socket);
});</code></pre>
<p>S√©√©√© loco, tanta coisa rolando aqui...</p>
<p>Comecemos com a ideia de que <code>Amp\Loop::run()</code> cria um Event Loop.
Se voc√™ n√£o sabe o que um event loop faz, d√° uma paradinha aqui
e vai buscar ler um pouco sobre isso. Tu vai encontrar coisas sobre
React PHP e Node.JS.</p>
<p>Na verdade, tenta aprender um teco como o React PHP funciona e
como ele enfileira tarefas e faz polling para opera√ß√µes de E/S (I/O),
lhe permitindo fazer programa√ß√£o ass√≠ncrona com PHP.</p>
<p>A coisa √© que esse Event Loop do Amp √© muito especial porque
<strong>ele n√£o √© s√≥ um event loop</strong>. Ele tamb√©m monitora <code>yield</code>,
portanto ele <strong>espera que a sua fun√ß√£o de callback seja uma
generator function</strong>!</p>
<p>Da√≠ al√©m de fazer o enfileiramento e monitorar E/S pra manter a thread
desocupada, ele tamb√©m trata valores que voc√™ der yield.</p>
<p>Ao equipar-se com <a href="https://github.com/reactphp/promise">React Promises</a>
<strong>ele te permite emular a funcionalidade async/await no PHP</strong>.</p>
<p>Mas como?</p>
<p>Se voc√™ der uma olhadinha mais de perto na
<a href="https://github.com/amphp/socket/blob/d49dc0d7936f65fd41068482da801768266d0c1a/src/functions.php#L63">implementa√ß√£o da fun√ß√£o connect</a>
notar√° que ela retorna uma Promise que quando resolvida ir√°
retornar um objeto <code>EncryptableSocket</code>.</p>
<p>Ent√£o <code>connect('localhost:443');</code> na verdade retorna uma Promise.
Como pode <code>$socket</code> conter <code>EncryptableSocket</code> ent√£o?</p>
<p>No momento em que n√≥s fazemos <code>yield</code> em uma Promise dentro
deste Event Loop, Amp ir√° aguardar esta promise resolver para
ent√£o devolver o valor (em caso de fulfil) ou lan√ßar exce√ß√£o
(em caso de reject).</p>
<p><strong>Namoral, num √© massa isso n√£o!? Diga√≠!</strong></p>
<p>Significa que voc√™ deveria escrever suas aplica√ß√µes dessa
maneira de agora em diante? Talvez, talvez n√£o...</p>
<p>Apesar de ser t√£o massa que n√£o precisemos esperar o
async/await chegar no core da linguagem, esse modelo parece
um tanto invasivo pra quem gosta de tipificar tudo.</p>
<p>Primeiro de tudo, isso te for√ßa a sempre retornar um Generator
no seu callback. O que √© at√© ok. Mas da√≠ tu precisaria <strong>retornar
Promise em todo canto</strong> pra tirar proveito dessa biblioteca.</p>
<p>O que tamb√©m pode ser ok, a galera do JavaScript faz isso
direto e n√£o fica chateada com isso. Mas sem Type Generics √©
dif√≠cil for√ßar os tipos de retorno das Promises.</p>
<p>Se voc√™ est√° ok com essa ideia, v√° em frente. Tem todo um mundo
a ser explorado! D√° uma olhada nos <a href="https://amphp.org/packages">pacotes dispon√≠veis no Framework Amp</a>
s√≥ pra ter certeza de que voc√™ n√£o v√° reinventar a roda.</p>
<h3>Otimiza√ß√£o de coleta de dados com Generators</h3>
<p>A gente t√° nessa era de web apis, o que √© bem maneiro. Existem
v√°rios padr√µes a se seguir enquando provedor de API: SOAP, REST,
GraphQL... O que acaba deixando pouco espa√ßo para aplica√ß√µes
MVC tradicionais que est√°vamos acostumados a ver h√° alguns anos.</p>
<p>Coisas como REST tendem a diminuir a √°rvore de depend√™ncias
da request: n√≥s especializamos um recurso por URL, que pode,
por exemplo, ser pr√© computado e armazenado num reposit√≥rio
de dados mega r√°pido.</p>
<p>Mas sempre que voc√™ pensar em m√∫ltiplos reposit√≥rios de dados
para compor uma resposta, Generator pode ser uma incr√≠vel
ferramenta para otimizar a utiliza√ß√£o de recursos e tempos
de resposta.</p>
<p>Talvez n√£o para apis REST, mas pensando em GraphQL √© natural
que o gerenciamento da coleta de dados √© importante. A
performance fala alto e n√≥s temos as ferramentas pra fazer
isso da forma correta.</p>
<p><a href="https://www.youtube.com/watch?v=YYt9u4uUetU">Nessa incr√≠vel apresenta√ß√£o do Bastian Hoffmann</a>
a gente consegue tomar alguma inspira√ß√£o a partir do momento
em que ele come√ßa a falar sobre widgets. A ideia de ter um
request handler para determinado tipo graphql que √© composto
de outros recursos mais granulares e ter essa √°rvore de depend√™ncias
organizada pode trazer benef√≠cios maravilhosos.</p>
<p>Imagine a seguinte requisi√ß√£o GraphQL (sintaxe simplificada):</p>
<pre><code class="language-gql">{
  person {
    name
  }
  team {
    people {
      name
      age
    }
  }
}</code></pre>
<p>O array de <code>people</code> pode conter o mesmo objeto <code>person</code>
entre seus elementos. Ent√£o por qu√™ solicitar <code>person</code> duas vezes?
Isto poderia ser otimizado numa √∫nica chamada.</p>
<p>Ent√£o por qu√™ n√£o algo parecido com o seguinte?</p>
<pre><code class="language-php">// PersonType.php
yield DataRequirement::craft(
  Person::class,
  ['name'],
  $whereClause
);

// PeopleType.php
yield DataRequirement::craft(
  Person::class,
  ['name', 'age'],
  $whereClause
);</code></pre>
<p>Parece um tanto estranho, n√©? E √© mesmo, dado que engenheiros(as)
php normalmente t√™m um ciclo de vida bem direto em suas
aplica√ß√µes.</p>
<p>Apenas imagine o qu√£o bacana seria se o handler chamando
<code>PersonType.php</code> fosse o mesmo chamando <code>PeopleType.php</code> e
ao dar yield nesses dois requisitos, um <code>Resolver</code> entenderia
que eles usam exatamente a mesma entidade e otimizaria a
chamada REST/SOAP/MongoDB para solicitar somente os campos
necess√°rios apenas uma vez.</p>
<p>Eu recentemente iniciei um POC em como desenvolver essa parada.
Parece com o snippet a seguir (que tu tamb√©m pode <a href="https://github.com/nawarian/resolver/blob/master/tests/integration/FetchThePhpWebsiteSitemapsTest.php#L43-L68i">encontrar aqui</a>).</p>
<pre><code class="language-php">public function fetchSitemaps(): Generator
{
  // Envolve o service para sempre retornar Promise.
  // Talvez pudesse ser feito com Annotations
  $sitemapProvider = wrap($this-&gt;sitemapService);

  list($this-&gt;en, $this-&gt;br) = yield [
    $sitemapProvider-&gt;getSitemap('en'),
    $sitemapProvider-&gt;getSitemap('br'),
  ];

  // Aqui $this-&gt;en e $this-&gt;br s√£o
  // populados com resultados do
  // getSitemap()
}</code></pre>
<p>O qu√£o mais eu desenvolvi essa POC, mais eu percebi que
se parecia com o Amp framework. Ent√£o acho que esse
seria <a href="https://amphp.org/amp/coroutines/">um bom ponto de partida.</a></p>
<p>Em geral, eu vejo grande potencial em Coroutines no PHP
e adoraria ver este lado da linguagem ser melhor desenvolvido.</p>
<p>Diz a√≠ o que tu acha! Me d√° um ping no Twitter e bora
desenvolver essa ideia juntos üòâ</p>
<div class="align-right">
  --
  <a href="https://twitter.com/nawarian" rel="nofollow">
    @nawarian
  </a>
</div>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "headline": "Voc&ecirc; achou que sabia sobre Generators no PHP",
  "description": "Neste post eu falo sobre Generators em PHP, como trabalhar com Coroutines e como o ecossistema da linguagem poderia evoluir com isso.",
  "image": [
    "https://thephp.website/assets/images/3-generators.jpg"
   ],
  "datePublished": "2019-12-23T00:00:00+08:00",
  "dateModified": "2019-12-23T00:00:00+08:00",
  "author": {
    "@type": "Person",
    "name": "Nawarian N&iacute;ckolas Da Silva"
  },
   "publisher": {
    "@type": "Organization",
    "name": "ThePHP Website",
    "logo": {
      "@type": "ImageObject",
      "url": "https://thephp.website/favicon.ico"
    }
  }
}
</script>  </article>
</body>
<script src="/assets/build/js/main.js?id=859740b518dcddb1fe42"></script>
</html>
