<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <link rel="stylesheet" href="/assets/build/css/main.css?id=bf2bc72a5feb7957052d">
      <link rel="canonical" href="https://thephp.website/en/issue/real-life-tdd-php/" />
      <link
    rel="alternate"
    type="application/json"
    title="[EN] thePHP Website"
    href="https://thephp.website/en/feed.json"
  />
  <link
    rel="alternate"
    type="application/rss+xml"
    title="[EN] thePHP Website"
    href="https://thephp.website/en/feed.xml"
  />
  
  <title>Test-Driven Development with PHP by example | thePHP Website</title>

  <meta name="description" content="This is how I approach Test-Driven Development (TDD) with PHP. The main focus is on the feedback loop tdd provides and which tools are suitable to bring us there when programming PHP.">

  <meta property="og:title" content="Test-Driven Development with PHP by example">
  <meta property="og:description" content="This is how I approach Test-Driven Development (TDD) with PHP. The main focus is on the feedback loop tdd provides and which tools are suitable to bring us there when programming PHP.">
  <meta property="og:url" content="https://thephp.website/en/issue/real-life-tdd-php">
  <meta property="og:image" content="https://thephp.website/assets/images/posts/1-test-640.webp">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@nawarian">
  <meta name="twitter:title" content="Test-Driven Development with PHP by example">
  <meta name="twitter:description" content="This is how I approach Test-Driven Development (TDD) with PHP. The main focus is on the feedback loop tdd provides and which tools are suitable to bring us there when programming PHP.">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-151169766-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-151169766-3');
  </script>
  <script data-ad-client="ca-pub-3681134868307419" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Hotjar Tracking Code for thephp.website -->
  <script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1770868,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
  </script>
  <script>
    function toggleMenu() {
      document.querySelector('.menu__container').classList.toggle('menu__container--active');
    }
  </script>
</head>
<body class="yue non-article">
  <header class="menu">
    <a class="menu__logo" href="/en/">
      <img src="/assets/images/elephpant-idle.png" alt="" />
    </a>
    <div class="menu__title">
      <a href="/en/">thePHP Website</a>
    </div>
    <section class="menu__cta">
      <button role="button" aria-label="Open Menu" class="menu__cta__icon" onclick="typeof toggleMenu == 'function' &amp;&amp; toggleMenu()">
        <img alt="Open Menu" src="https://podentender.com.br/assets/images/icons/menu.svg">
      </button>
    </section>

    <div class="menu__container">
      <em class="menu__section-heading">
        Pages.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="/en/">Home</a>
        </li>
        <li class="menu__list-item">
          <a href="/en/search">
            search.php
          </a>
        </li>
        <li class="menu__list-item">
          <a
            href="https://github.com/nawarian/The-PHP-Website/issues/new?title=[Suggested+Topic]%20&body=Please+describe+your+suggestion+/+Por+favor+descreva+sua+sugestÃ£o"
            rel="nofollow"
          >
            Suggest a Topic!
          </a>
        </li>
        <li class="menu__list-item">
          <a href="/en/about/">
            about.php
          </a>
        </li>
      </ul>

      <hr>
      <em class="menu__section-heading">
        Languages.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="/en/">English</a>
        </li>
        <li class="menu__list-item">
          <a href="/br/">PortuguÃªs</a>
        </li>
      </ul>

      <hr>
      <em class="menu__section-heading">
        Notifications.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="https://thephp.website/en/feed.json">
            [EN] JSON Feed
          </a>
        </li>
        <li class="menu__list-item">
          <a href="https://thephp.website/en/feed.xml">
            [EN] Atom Feed (RSS)
          </a>
        </li>
              </ul>
    </div>
  </header>
  <article class="container">
      <div class="article">
    <time datetime="2019-11-03">
      2019-11-03
    </time>

    <h1>Test-Driven Development with PHP by example</h1>
    <p><a href="/br/edicao/tdd-com-php-na-vida-real">Leia em PortuguÃªs</a></p>

<p><strong>Before you start</strong></p>

<p>TDD has many techniques to be used, this post presents a couple of them.
If you seek deeper knowledge on Test-Driven Development, there's a book
for you: <strong><em>"Test Driven Development: By Example"</em>, by Kent Beck</strong>.</p>

<p>All code written here is available on <a href="https://github.com/nawarian/The-PHP-Website/tree/master/code/1-real-life-tdd-with-php/archive-org-client">thephp.website's github repository</a>.</p>

<p><strong>No BS mode: ON.</strong> (let's move fast!)</p>

<p>Test Driven Development is not about writing unit tests, <strong>it is about
testing first</strong>.</p>

<p>Tests are not the most important thing, <strong>we write them to have quick
and constant feedback</strong> during development.</p>

<p>Being that said, our development cycle looks like the following:
1. <a href="#1-write-a-high-level-test">Write a high-level test, run and see it fail</a>
1. <a href="#2-make-this-test-succeed-the-dumbest-way-possible">Make this test succeed the dumbest way possible</a>
1. <a href="#3-refactor-the-dumb-implementation-until-is-no-longer-dumb">Refactor the dumb implementation until is no longer dumb</a></p>

<h2>Before "how", comes "why"</h2>

<p>There are a couple of great reasons to write tests first. Be aware of
them so you understand why keep such practices.</p>

<p>Writing test first:
* forces you to know what you want to achieve before you start coding
* keeps you focused on your goal
* engages you into a constant feedback cycle: change, save, run test</p>

<h2>Building a metadata adapter for Archive.org with TDD</h2>

<p>To come up with a reasonable coding example, let's build a client
to fetch metadata from Archive.org's items.</p>

<p><strong>What we know:</strong></p>

<ul>
<li>Archive.org allows uploading files and call them "Item"</li>
<li><a href="https://archive.org/details/nawarian-test">Here's an example of Item named "nawarian-test"</a></li>
<li>An item contains multiple files, representing the file in multiple
forms and its metadata</li>
<li>Every item contains metadata like creation date, name, files...</li>
<li>Archive.org provides an API to fetch metadata with the following
URL pattern: <code>https://archive.org/metadata/&lt;item-name&gt;</code></li>
</ul>

<p><strong>What we want:</strong></p>

<p>A class to query an item's metadata on Archive.org and respond
with a custom entity class named <code>Nawarian\ArchiveOrg\Item\Metadata</code>.</p>

<p>Let's then build our basic setup and write our test to guarantee
we'll achieve what we want.</p>

<h2>Set up the testing environment</h2>

<p>Very quickly: let's create a new folder for our project, install
all required packages and get tests up and running. My setup usually
comes with PHPUnit and Mockery:</p>

<p>```shell script
$ mkdir archive-org-client/ &amp;&amp; cd archive-org-client
$ composer require phpunit/phpunit mockery/mockery
$ ./vendor/bin/phpunit --generate-configuration</p>

<pre><code><br />While generating phpunit config you'll be asked about tests dir and
other things. Pick the default one for every prompt (simply press enter).

The default set up expect us to write our tests under a `tests` folder,
and our code under `src`. Let's create them:

```shell script
$ mkdir tests src
</code></pre>

<p>We also need to configure composer's <strong>autoloader</strong>. Update <code>composer.json</code>
so it looks like the following:</p>

<p>File: <strong>composer.json</strong></p>

<pre><code class="language-json">{
    "require": {
        "phpunit/phpunit": "^8.4",
        "mockery/mockery": "^1.2"
    },
    "autoload": {
        "psr-4": {
            "Nawarian\\ArchiveOrg\\": "src/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Nawarian\\ArchiveOrg\\Test\\": "tests/"
        }
    }
}
</code></pre>

<p>With the new <code>composer.json</code> in place, let's generate the autoloader again:
```shell script
$ composer dump-autoload</p>

<pre><code><br />We can now create our test class and start moving!

File: **tests/ClientTest.php**
```php
&lt;?php

namespace Nawarian\ArchiveOrg\Test;

use PHPUnit\Framework\TestCase;

class ClientTest extends TestCase
{
    public function testMyTest(): void
    {
        $this-&gt;assertTrue(true);
    }
}
</code></pre>

<p>And make sure phpunit can run our test normally:
```shell script
$ ./vendor/bin/phpunit -c phpunit.xml</p>

<pre><code><br />Well done! With our test set up in hands, let's move to our
first step on tdd.



<h3 id="1-write-a-high-level-test">
    1. Write a high-level test, run and see it fail
</h3>



Our goal, again: A class to query an item's metadata on Archive.org
and respond with a custom entity class named
`Nawarian\ArchiveOrg\Item\Metadata`. 

Our test must look like the following:

File: **tests/ClientTest.php**
```php
&lt;?php

namespace Nawarian\ArchiveOrg\Test;

use PHPUnit\Framework\TestCase;

class ClientTest extends TestCase
{
    public function testClientFetchesMetadata(): void
    {
        $client = new \Nawarian\ArchiveOrg\Client();

        $metadata = $client-&gt;fetchMetadata('nawarian-test');

        $this-&gt;assertSame('nawarian-test', $metadata-&gt;identifier());
        $this-&gt;assertSame('2019-02-19 20:00:38', $metadata-&gt;publicDate());
        $this-&gt;assertSame('opensource', $metadata-&gt;collection());
    }
}
</code></pre>

<p>That's it! We need a <code>Client</code> that contains a <code>fetchMetadata()</code> method,
that receives an <code>identifier</code> string (nawarian-test in our case). We
also want this metadata to be an object with <code>identifier()</code>, <code>publicDate()</code>
and <code>collection()</code> methods, returning the values available on the API.</p>

<p><strong>Save, run phpunit and see the test failing.</strong></p>

<h3 id="2-make-this-test-succeed-the-dumbest-way-possible">
    2. Make this test succeed the dumbest way possible
</h3>

<p>First error we see says <code>Class 'Nawarian\ArchiveOrg\Client' not found</code>.
Fixing it is simple, create a class matching this FQN. Let's do it under
<code>src/</code>.</p>

<p>File: <strong>src/Client.php</strong></p>

<pre><code class="language-php">&lt;?php

namespace Nawarian\ArchiveOrg;

class Client
{
}
</code></pre>

<p>Save, run phpunit. Next error says <code>Call to undefined method Nawarian\ArchiveOrg\Client::fetchMetadata()</code>.
Even easier, just add the method to the <code>Client</code> class:</p>

<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    return new \stdClass();
}
</code></pre>

<p>Save, run phpunit. Next error says <code>Call to undefined method stdClass::identifier()</code>.
Let's then use anonymous classes to quickly remove these errors
from our screen!</p>

<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    return new class {
        public function identifier(): string
        {
            return '';
        }

        public function publicDate(): string
        {
            return '';
        }

        public function collection(): string
        {
            return '';
        }
    };
}
</code></pre>

<p>What's missing now is to make our test pass <strong>the dumbest way possible</strong>.
I can only think of hard-coding the values to match our assertions:</p>

<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    return new class {
        public function identifier(): string
        {
            return 'nawarian-test';
        }

        public function publicDate(): string
        {
            return '2019-02-19 20:00:38';
        }

        public function collection(): string
        {
            return 'opensource';
        }
    };
}
</code></pre>

<p>Awesome! Tests are passing! Time to make the implementation real, so we
can fetch metadata from the API itself. <strong>From this moment we start
our feedback loop during development.</strong></p>

<h3 id="3-refactor-the-dumb-implementation-until-is-no-longer-dumb">
    3. Refactor the dumb implementation UNTIL is no longer dumb
</h3>

<p>The <strong>until</strong> word here is extremely important. This is the last, but
repeatable step.</p>

<p>This means that we keep coming back to it until we're happy with the
implementation.</p>

<p><strong>3.1 Introducing the <code>Item\Metadata</code> class</strong></p>

<p>First refactoring I feel like is to come up with our <code>Metadata</code> class,
this way we can remove that nasty <code>return new class {};</code>. To it:</p>

<p>File: <strong>src/Item/Metadata.php</strong> (methods copied from Client's anonymous class)</p>

<pre><code class="language-php">&lt;?php

namespace Nawarian\ArchiveOrg\Item;

class Metadata
{
    public function identifier(): string
    {
        return 'nawarian-test';
    }

    public function publicDate(): string
    {
        return '2019-02-19 20:00:38';
    }

    public function collection(): string
    {
        return 'opensource';
    }
}
</code></pre>

<p>Update <code>Client::fetchMetadata()</code> implementation right away. Notice how
return type also changed to <code>Metadata</code>.</p>

<p>File: <strong>src/Client.php</strong></p>

<pre><code class="language-php">// ...

use Nawarian\ArchiveOrg\Item\Metadata;

// class Client...

public function fetchMetadata(string $identifier): Metadata
{
    return new Metadata();
}
</code></pre>

<p>Save, run phpunit. Tests are still passing. We're doing great!</p>

<p><strong>3.2 Add requested information to <code>Metadata</code>'s constructor</strong></p>

<p>Instead of hard coding our result to <code>Metadata</code>'s file, let's delegate
the data passing responsibility to the <code>Client</code> class and receive data
from <code>Metadata</code>'s constructor:</p>

<p>File: <strong>src/Item/Metadata.php</strong></p>

<pre><code class="language-php">class Metadata
{
    private $identifier;

    private $publicDate;

    private $collection;

    public function __construct(string $identifier, string $publicDate, string $collection)
    {
        $this-&gt;identifier = $identifier;
        $this-&gt;publicDate = $publicDate;
        $this-&gt;collection = $collection;
    }

    public function identifier(): string
    {
        return $this-&gt;identifier;
    }

    public function publicDate(): string
    {
        return $this-&gt;publicDate;
    }

    public function collection(): string
    {
        return $this-&gt;collection;
    }
}
</code></pre>

<p>And now we delegate data passing to <code>Client</code>.</p>

<p>File: <strong>src/Client.php</strong></p>

<pre><code class="language-php">public function fetchMetadata(string $identifier): Metadata
{
    return new Metadata('nawarian-test', '2019-02-19 20:00:38', 'opensource');
}
</code></pre>

<p>Save, run phpunit. Everything is still green. Move on!</p>

<p><strong>3.3 Call the API to fetch actual data</strong></p>

<p><code>Client</code> is still providing fake data, which is not really cool.
Let's hit the archive.org's API to fetch the data we need.</p>

<p>Remember the endpoint is <code>https://archive.org/metadata/&lt;identifier&gt;</code>. So by
calling <code>Client::fetchMetadata()</code> passing <code>nawarian-test</code> as identifier (test
is already doing this), we should call <code>https://archive.org/metadata/nawarian-test</code>.</p>

<p>I'll quickly do this by using <code>file_get_contents()</code>:</p>

<p>File: <strong>src/Client.php</strong></p>

<pre><code class="language-php">public function fetchMetadata(string $identifier): object
{
    $jsonData = file_get_contents("https://archive.org/metadata/{$identifier}");
    $decoded = json_decode($jsonData, true);
    $metadata = $decoded['metadata'];

    return new Metadata(
        $metadata['identifier'],
        $metadata['publicdate'],
        $metadata['collection']
    );
}
</code></pre>

<p>Save, run phpunit. Tests are passing. We achieved our goal.</p>

<h2>Keep refactoring or call it a day</h2>

<p>The main idea of the loop described on step 3.3 is to implement towards
a very well defined goal.</p>

<p>You'll face many "aargh" moments, and will want to implement the best way
possible right in the beginning. <strong>Don't fall into this trap!</strong></p>

<p>The longer you stay without feedback (without seeing test results), the bigger
your chances to make a breaking change without realizing.</p>

<p>Whenever you want to do something you feel is very important, note it down
and keep moving forward! Keep it as the next item in your refactoring loop,
but don't stop your current iteration.</p>

<p>I can name a few things I'd like to do with the current implementation we have:</p>

<ul>
<li>I'd like to have a PSR-18 compatible http client and remove the
<code>file_get_contents()</code> call</li>
<li>I'd like to split our test into unit and integration</li>
<li>I'd like to have a better hydration for <code>Metadata</code> class</li>
</ul>

<p>Also important to notice we didn't test any exception case. Those should
be part of your implementation as well! How should the program behave
when <code>identifier</code> doesn't exist?</p>

<p>The more you code, the more you'll want to code. Your job here is to
understand when you should stop and move on to next topic.</p>

<p><strong>Just never forget to keep the feedback loop going: refactor, save,
run phpunit.</strong></p>

<p>That's it. No need to wait for implementing TDD any longer.</p>

<p>Keep rocking, read Kent Beck's book and feel free to reach me out
for questions or complaints.</p>

<div class="align-right">
  --
  <a href="https://twitter.com/nawarian" rel="nofollow">
    @nawarian
  </a>
</div>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "headline": "Test-Driven Development with PHP by example",
  "description": "This is how I approach Test-Driven Development (TDD) with PHP. The main focus is on the feedback loop tdd provides and which tools are suitable to bring us there when programming PHP.",
  "image": [
    "https://thephp.website/assets/images/1-test.jpg"
   ],
  "datePublished": "2019-11-03T00:00:00+08:00",
  "dateModified": "2020-02-17T00:00:00+08:00",
  "author": {
    "@type": "Person",
    "name": "Nawarian NÃ­ckolas Da Silva"
  },
   "publisher": {
    "@type": "Organization",
    "name": "ThePHP Website",
    "logo": {
      "@type": "ImageObject",
      "url": "https://thephp.website/favicon.ico"
    }
  }
}
</script>
  </div>
  </article>
  <aside class="container">
          <div class="recommended">
      <h3>Keep reading</h3>
      <ul class="card-list">
                  <li class="card">
            <a href="https://thephp.website/en/issue/how-to-write-crawlers-with-php/">
                              <div
                        class="card__image"
                        style="background-image: url(/assets/images/posts/16-many-books-and-magazines-640.webp)"
                        alt="Many books and magazines."
                ></div>
              
              <div class="card__content">
                <h4>How to write php crawlers with spatie/crawler</h4>
                <p>After this article you&#039;ll realize how much you were suffering with your PHP crawlers. There IS a better way. Let me show it to you ðŸ˜‰</p>
                <time>2020-07-20</time>
              </div>
            </a>
          </li>
                  <li class="card">
            <a href="https://thephp.website/en/issue/games-with-php/">
                              <div
                        class="card__image"
                        style="background-image: url(/assets/images/posts/14-snake-640.webp)"
                        alt="A colorful snake facing the camera."
                ></div>
              
              <div class="card__content">
                <h4>Simple PHP Game in PHP using Raylib: Snake (with source code)</h4>
                <p>I&#039;m gonna show you how the code looks like and which tools I used! Hopefully it will catch your attention enough to see this extension getting traction.</p>
                <time>2020-04-12</time>
              </div>
            </a>
          </li>
                  <li class="card">
            <a href="https://thephp.website/en/issue/php-docker-quick-setup/">
                              <div
                        class="card__image"
                        style="background-image: url(/assets/images/posts/7-container-640.webp)"
                        alt="A man jumping over a container"
                ></div>
              
              <div class="card__content">
                <h4>Setting up PHP, Docker and PHPUnit</h4>
                <p>In this post I quickly show my custom setup for php applications using PHPUnit and Docker and quick configs almost every application needs.</p>
                <time>2020-02-17</time>
              </div>
            </a>
          </li>
              </ul>
    </div>
    </aside>
</body>
<script src="/assets/build/js/main.js?id=fd09420d5a6aa331aa18"></script>
</html>
