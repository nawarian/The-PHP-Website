<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <link rel="stylesheet" href="/assets/build/css/main.css?id=fe8dc2a406fe72bf88aa">
  <link
    rel="alternate"
    type="application/json"
    title="[EN] thePHP Website"
    href="https://thephp.website/en/feed.json"
  />
  <link
    rel="alternate"
    type="application/rss+xml"
    title="[EN] thePHP Website"
    href="https://thephp.website/en/feed.xml"
  />
  
  <title>How to write decent crawlers with php | thePHP Website</title>

  <meta name="description" content="After this article you&#039;ll realize how much you were suffering with your PHP crawlers. There IS a better way. Let me show it to you üòâ">

  <meta property="og:title" content="How to write decent crawlers with php">
  <meta property="og:description" content="After this article you&#039;ll realize how much you were suffering with your PHP crawlers. There IS a better way. Let me show it to you üòâ">
  <meta property="og:url" content="https://thephp.website/en/issue/how-to-write-crawlers-with-php">
  <meta property="og:image" content="https://thephp.website/assets/images/posts/16-many-books-and-magazines-640.webp">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@nawarian">
  <meta name="twitter:title" content="How to write decent crawlers with php">
  <meta name="twitter:description" content="After this article you&#039;ll realize how much you were suffering with your PHP crawlers. There IS a better way. Let me show it to you üòâ">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-151169766-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-151169766-1');
  </script>
  <script data-ad-client="ca-pub-3681134868307419" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Hotjar Tracking Code for thephp.website -->
  <script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1770868,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>
</head>
<body class="yue non-article">
  <nav class="menu">
    <input type="checkbox" id="menu-toggle" class="menu__toggle" />
    <label for="menu-toggle" class="menu__toggle-button">
      <img class="menu__toggle-button--inactive" src="/assets/images/burger-menu-icon.png" alt="Open Menu">
      <img class="menu__toggle-button--active" src="/assets/images/x-icon.png" alt="Close Menu">
    </label>
    <div class="menu__header">
      <a href="/en/">
        thePHP Website
      </a>
    </div>

    <div class="menu__container">
      <em class="menu__section-heading">
        Pages.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="/en/">Home</a>
        </li>
        <li class="menu__list-item">
          <a href="/en/search">
            search.php
          </a>
        </li>
        <li class="menu__list-item">
          <a
            href="https://github.com/nawarian/The-PHP-Website/issues/new?title=[Suggested+Topic]%20&body=Please+describe+your+suggestion+/+Por+favor+descreva+sua+sugest√£o"
            rel="nofollow"
          >
            Suggest a Topic!
          </a>
        </li>
        <li class="menu__list-item">
          <a href="/en/about/">
            about.php
          </a>
        </li>
      </ul>

      <hr>
      <em class="menu__section-heading">
        Languages.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="/en/">English</a>
        </li>
        <li class="menu__list-item">
          <a href="/br/">Portugu√™s</a>
        </li>
      </ul>

      <hr>
      <em class="menu__section-heading">
        Notifications.php
      </em>
      <ul class="menu-list">
        <li class="menu__list-item">
          <a href="https://thephp.website/en/feed.json">
            [EN] JSON Feed
          </a>
        </li>
        <li class="menu__list-item">
          <a href="https://thephp.website/en/feed.xml">
            [EN] Atom Feed (RSS)
          </a>
        </li>
              </ul>
    </div>
  </nav>

  <article class="container">
      <div class="article">
    <time datetime="2020-07-20">
      2020-07-20
    </time>

    <h1>How to write decent crawlers with php</h1>
    <p><a href="/br/edicao/como-escrever-crawlers-em-php/">Leia em Portugu√™s</a></p>
<p>You probably have seen many posts on how to write crawlers with php. What differs
this post from others? I‚Äôll make sure you don‚Äôt lose your mind thinking about
regular expressions, global variables and all sort of annoying stuff.</p>
<p>We‚Äôll be using an amazing tool named Spatie/Crawler which will provide us with a
great interface for writing crawlers without going absolutely crazy!</p>
<p><strong>Below you‚Äôll find a video of mine coding this crawler. Just scroll down if you‚Äôd
like to jump right into action!</strong> üòâ</p>
<h2>Our use case</h2>
<p>This crawler will be rather simple and intends to fetch names, nicknames and e-mails
from the official PHP directory of people who support(ed) the language somehow.</p>
<p>You can check out the entire directory in this url: <a href="https://people.php.net">https://people.php.net</a>.</p>
<h2>Set up the development environment</h2>
<p>The environment set up will be very quick and dirty, I‚Äôll just copy over the <em>composer</em>
and <em>php</em> sections from this other post I wrote on
<a href="/en/issue/php-docker-quick-setup/">how to quickly set up a docker environment for development</a>.</p>
<p>My <em>docker-compose.yml</em> file looks like this:</p>
<pre><code class="language-yaml">version: '3'
services:
  composer:
    image: composer:1.9.3
    environment:
      - COMPOSER_CACHE_DIR=/app/.cache/composer
    volumes:
      - .:/app
    restart: never

  php:
    image: php:7.4-cli
    restart: never
    volumes:
      - .:/app
    working_dir: /app</code></pre>
<p>Now let‚Äôs require the packages:</p>
<pre><code class="language-bash">$ docker-compose run \
  composer require \
    spatie/crawler \
    symfony/css-selector</code></pre>
<p>All we need now is an entry point, let‚Äôs create a file bin/crawler.php:</p>
<pre><code class="language-bash">$ mkdir bin
$ touch bin/crawler.php</code></pre>
<p>Nice and simple, now just add the autoload requirement and we‚Äôre ready to start:</p>
<pre><code class="language-php">// bin/crawler.php
&lt;?php

require_once __DIR__ . 
  '/../vendor/autoload.php';</code></pre>
<p>From now on, we can just run our program by typing docker-compose run php php
bin/crawler.php. Simple as that! üòâ</p>
<pre><code class="language-bash">$ docker-compose run php \
  php bin/crawler.php</code></pre>
<h2>Let‚Äôs take a look on the target website</h2>
<p>Normally we should navigate around and figure out how the website works: url patterns,
ajax calls, csrf tokens, if feeds or APIs are available.</p>
<p>In this case, neither feeds nor APIs are available. We need a raw crawling to fetch
html data and parse it.</p>
<p>I see some url patterns:</p>
<ul>
<li>Person profile page: people.php.net/{nickname}</li>
<li>Directory page: people.php.net/?page={number}</li>
<li>External links</li>
</ul>
<p>Seems nice and simple! We should only care about parsing the HTML inside person
profile pages and ignore the other ones.</p>
<p>By checking the profile page we can quickly fetch the selectors that are important to us:</p>
<ul>
<li>Name: <code>h1[property=foaf:name]</code></li>
<li>Nickname: <code>h1[property=foaf:nick]</code></li>
</ul>
<p>We can also trust that people‚Äôs e-mail there are basically ‚Äú{nick}@php.net‚Äù.
With this info in hands, let‚Äôs code!</p>
<h2>Crawling all php people and extracting public data</h2>
<p>Below you'll find the code, but if you like videos more, just check this one
below:</p>
<iframe style="margin: auto;" width="560" height="315" src="https://www.youtube.com/embed/HaMoYhTV1hI?start=21" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen><iframe style="margin: auto;" width="560" height="315" src="https://www.youtube.com/embed/HaMoYhTV1hI?start=21" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></iframe>
<p>Unfortunately it is in Brazilian Portuguese, but I'll try to make an english version
soon. You can just follow the code, though. Is fairly simple, code is in english
and portuguese is a super cool language! :P</p>
<h2>Coding time!</h2>
<p>So, <code>spatie/crawler</code> brings two very important abstract classes - which I wish were interfaces instead.</p>
<p>One of them is the <code>CrawlObserver</code> class, where we can hook into crawling
steps and manipulate http responses. Our logic enters here.</p>
<p>I'll write an observer very quickly with an anonymous class below:</p>
<pre><code class="language-php">$observer = new class
  extends CrawlObserver
{
  public function crawled(
    $url,
    $response,
    $foundOnurl
  ) {
    $domCrawler = new DomCrawler(
      (string) $response-&gt;getBody()
    );

    $name = $domCrawler
      -&gt;filter('h1[property="foaf:name"]')
      -&gt;first()
      -&gt;text();
    $nick = $domCrawler
      -&gt;filter('h2[property="foaf:nick"]')
      -&gt;first()
      -&gt;text();
    $email = "{$nick}@php.net";

    echo "[{$email}] {$name} - {$nick}" . PHP_EOL;
  }
};</code></pre>
<p>The above logic will fetch the properties we expect from our pages.
Of course we should also check whether we are in the correct page or not.</p>
<p>Now, the next important bit is the <code>CrawlProfile</code> abstract class. With this one
we can decide whether an URL should or not be accessed by an Observer.
Let's create one with an anonymous class here:</p>
<pre><code class="language-php">$profile = new class
  extends CrawlProfile
{
  public function shouldCrawl(
    $url
  ): bool {
    return $url-&gt;getHost() ===
      'people.php.net';
  }
};</code></pre>
<p>Above we're defining that we only want to follow internal links. That's because
this website links to many other repositories. And we don't want to crawl the
entire php universe, do we?</p>
<p>With those two instances in hand, we can prepare the crawler itself and start it:</p>
<pre><code class="language-php">Crawler::create()
  -&gt;setCrawlObserver($observer)
  -&gt;setCrawlProfile($profile)
  -&gt;setDelayBetweenRequests(500)
  -&gt;startCrawling(
    'https://people.php.net/'
  );</code></pre>
<p><strong>Important!</strong> Do you see that <code>setDelayBetweenRequests(500)</code>? It makes the crawler
fetch one URL every 500 milliseconds. That's because we don't want to take this website
down, right? (Really, please don't. Pick a governmental website from Brazil instead üëÄ)</p>
<h2>That's it</h2>
<p>Quick and dirty, but most importantly: sane! <code>spatie/crawler</code> provides a great interface
that simplifies the process a lot.</p>
<p>Mix this tool with proper dependency injection and queueing and you'll have professional
results.</p>
<p>Ping me on twitter if you have any questions!
Cheers! üëã</p>
<div class="align-right">
  --
  <a href="https://twitter.com/nawarian" rel="nofollow">
    @nawarian
  </a>
</div>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "headline": "How to write decent crawlers with php",
  "description": "After this article you'll realize how much you were suffering with your PHP crawlers. There IS a better way.",
  "image": [
    "https://thephp.website/assets/images/posts/16-many-books-and-magazines-640.webp"
   ],
  "datePublished": "2020-07-20T00:00:00+08:00",
  "dateModified": "2020-07-20T00:00:00+08:00",
  "author": {
    "@type": "Person",
    "name": "Nawarian N&iacute;ckolas Da Silva"
  },
   "publisher": {
    "@type": "Organization",
    "name": "ThePHP Website",
    "logo": {
      "@type": "ImageObject",
      "url": "https://thephp.website/favicon.ico"
    }
  }
}
</script>  </div>
  </article>
</body>
<script src="/assets/build/js/main.js?id=d8d97153f6ef3455152f"></script>
</html>
